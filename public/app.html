<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QuickListing — App</title>
  <link rel="stylesheet" href="/styles.css"/>
  <style>
    /* small app-only tweaks */
    .app-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .panel h2{margin:0 0 10px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .muted{color:#c1c9d5;font-size:14px}
    .out-title{font-size:20px;font-weight:800;margin:0 0 6px}
    .bullets{margin:8px 0 12px 18px}
    .desc{white-space:pre-wrap;line-height:1.5}
    .top-actions{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px}
    .small-btn{padding:6px 10px;border-radius:8px;font-weight:700;font-size:13px}
    @media(max-width:980px){.app-grid{grid-template-columns:1fr}.row{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header class="nav">
  <div class="container nav-row">
    <a class="brand" href="/"><img src="/logo.svg" alt=""/>QuickListing</a>
    <nav class="nav-actions">
      <a href="/upgrade" class="btn ghost">Upgrade</a>
    </nav>
  </div>
</header>

<main class="container" style="padding:24px 0">
  <div class="app-grid">

    <!-- LEFT -->
    <section class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <h2>Step 1</h2>
        <button id="useExample" class="btn small-btn" type="button">Use Example</button>
      </div>

      <label class="muted" for="features">Key features</label>
      <textarea id="features" rows="9" placeholder="2 bed, 1 bath, renovated kitchen, in-unit laundry, balcony, etc."></textarea>

      <div class="row">
        <div>
          <label class="muted">Tone</label>
          <select id="tone">
            <option>Professional</option>
            <option>Warm</option>
            <option>Luxury</option>
            <option>Casual</option>
          </select>
        </div>

        <div>
          <label class="muted">Length</label>
          <select id="length">
            <option value="short">Short (2–3 sentences)</option>
            <option value="medium">Medium (1 paragraph)</option>
            <option value="long">Long (2 paragraphs)</option>
          </select>
        </div>

        <div>
          <label class="muted">Audience</label>
          <select id="audience">
            <option>Buyers</option>
            <option>Renters</option>
            <option>Investors</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="generateBtn" class="btn" type="button">Generate</button>
        <button id="clearBtn" class="btn ghost" type="button">Clear</button>
        <div id="meter" class="muted" style="align-self:center;margin-left:auto;"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <h2>Step 2</h2>
        <div class="top-actions">
          <button id="copyTitle" class="btn ghost small-btn" type="button">Copy Title</button>
          <button id="copyDesc" class="btn ghost small-btn" type="button">Copy Description</button>
        </div>
      </div>

      <div id="output">
        <div class="out-title muted">(Title will appear here)</div>
        <ul class="bullets"></ul>
        <div class="desc muted">(Description will appear here)</div>
      </div>
    </section>

  </div>
</main>

<footer class="footer">
  <div class="container footrow">
    <span>© 2025 QuickListing</span>
    <nav class="footnav">
      <a href="/app">App</a>
      <a href="/#pricing">Pricing</a>
      <a href="/upgrade">Upgrade</a>
    </nav>
  </div>
</footer>

<!-- Upgrade Modal -->
<div id="upgradeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#111827; border:1px solid #1f2937; border-radius:14px; padding:20px; width:min(420px,90vw); text-align:center;">
    <h2 style="margin:0 0 6px;">Free limit reached</h2>
    <p style="color:#c1c9d5; margin:0 0 14px;">
      You used all 10 free descriptions for this month.
      Upgrade to keep generating.
    </p>
    <div style="display:grid; gap:10px;">
      <a href="/upgrade" class="btn block">See Plans</a>
      <button id="closeUpgrade" class="btn ghost block" type="button">Not now</button>
    </div>
  </div>
</div>

<script>
  // ---------- Upgrade modal ----------
  function showUpgradeModal(){
    const m = document.getElementById("upgradeModal");
    const close = document.getElementById("closeUpgrade");
    if (!m) return;
    m.style.display = "flex";
    if (close) close.onclick = () => (m.style.display = "none");
    m.onclick = (e) => { if (e.target === m) m.style.display = "none"; };
  }

  // ---------- Generate helper (handles boss key + limit popup) ----------
  async function qlGenerate(body){
    const adminKey = localStorage.getItem("QL_ADMIN_KEY") || "";

    const res = await fetch("/generate", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...(adminKey ? { "x-admin-key": adminKey } : {})
      },
      body: JSON.stringify(body)
    });

    // show upgrade popup on limit
    if (res.status === 402) {
      showUpgradeModal();
      throw new Error("Limit reached");
    }

    if (!res.ok) {
      const err = await res.json().catch(()=>({}));
      throw new Error(err.error || "Server error");
    }

    // show remaining in footer meter (reads response headers)
    const plan = res.headers.get("X-Plan") || "free";
    const remaining = res.headers.get("X-Remaining") || "";
    const meter = document.getElementById("meter");
    if (meter) meter.textContent = plan === "boss"
      ? "Boss mode: unlimited"
      : `Plan: ${plan} • Remaining: ${remaining}`;

    return res.json();
  }

  // ---------- UI wiring ----------
  const featuresEl = document.getElementById("features");
  const toneEl = document.getElementById("tone");
  const lengthEl = document.getElementById("length");
  const audienceEl = document.getElementById("audience");
  const outputEl = document.getElementById("output");
  const bulletsEl = outputEl.querySelector(".bullets");
  const titleEl = outputEl.querySelector(".out-title");
  const descEl = outputEl.querySelector(".desc");

  document.getElementById("useExample").onclick = () => {
    featuresEl.value = "2 bed, 1 bath, renovated kitchen, in-unit laundry, balcony, hardwood floors, near subway";
  };

  document.getElementById("clearBtn").onclick = () => {
    featuresEl.value = "";
    titleEl.textContent = "(Title will appear here)";
    bulletsEl.innerHTML = "";
    descEl.textContent = "(Description will appear here)";
    titleEl.classList.add("muted");
    descEl.classList.add("muted");
  };

  document.getElementById("generateBtn").onclick = async () => {
    const features = featuresEl.value.trim();
    if (!features) return alert("Please enter key features.");

    titleEl.textContent = "Generating...";
    descEl.textContent = "";
    bulletsEl.innerHTML = "";

    try {
      const data = await qlGenerate({
        features,
        tone: toneEl.value,
        length: lengthEl.value,
        audience: audienceEl.value
      });

      const title = data?.meta?.title || "Listing Title";
      const bullets = data?.meta?.bullets || [];
      const description = data?.description || "";

      titleEl.textContent = title;
      titleEl.classList.remove("muted");

      bulletsEl.innerHTML = bullets.map(b => `<li>${b}</li>`).join("");

      descEl.textContent = description;
      descEl.classList.remove("muted");
    } catch (err) {
      console.error(err);
      titleEl.textContent = "(Error)";
      titleEl.classList.add("muted");
      descEl.textContent = err.message || "Something went wrong.";
      descEl.classList.add("muted");
    }
  };

  document.getElementById("copyTitle").onclick = async () => {
    const t = titleEl.textContent || "";
    if (!t || t.includes("(Title")) return;
    await navigator.clipboard.writeText(t);
  };

  document.getElementById("copyDesc").onclick = async () => {
    const bullets = [...bulletsEl.querySelectorAll("li")].map(li => "- " + li.textContent).join("\n");
    const d = descEl.textContent || "";
    const text = (titleEl.textContent || "") + "\n\n" + bullets + "\n\n" + d;
    if (!d || d.includes("(Description")) return;
    await navigator.clipboard.writeText(text);
  };
</script>

</body>
</html>
